<!doctype html>
<html lang="ko">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì£¼ë¬¸/ê²°ì œ</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');
    
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Jua', sans-serif;
      background-color: #f8f9fa;
    }
    
    html {
      height: 100%;
    }
    
    .app-container {
      display: flex;
      flex-direction: column;
      min-height: 100%;
      max-width: 480px;
      margin: 0 auto;
      background-color: #ffffff;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }
    
    /* ìƒë‹¨ë°” */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background-color: #ffffff;
      border-bottom: 2px solid #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .back-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      font-size: 24px;
      transition: transform 0.2s;
    }
    
    .back-btn:hover {
      transform: scale(1.1);
    }
    
    .page-title {
      font-size: 24px;
      font-weight: bold;
      color: #2d3436;
      margin: 0;
      flex: 1;
      text-align: center;
    }
    
    .placeholder {
      width: 40px;
    }
    
    /* ë©”ì¸ ì»¨í…ì¸  */
    .main-content {
      flex: 1;
      padding: 20px;
      padding-bottom: 220px; /* í•˜ë‹¨ ê³ ì • ì˜ì—­ ë†’ì´ë§Œí¼ ì—¬ìœ  ê³µê°„ í™•ë³´ */
      overflow-y: auto;
      -webkit-overflow-scrolling: touch; /* iOS ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
    }
    
    /* ì„¹ì…˜ ê³µí†µ ìŠ¤íƒ€ì¼ */
    .section {
      margin-bottom: 24px;
      padding: 20px;
      background-color: #f8f9fa;
      border-radius: 12px;
      border: 2px solid #e9ecef;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: bold;
      color: #2d3436;
      margin: 0 0 16px 0;
      padding-bottom: 12px;
      border-bottom: 2px solid #e9ecef;
    }
    
    /* ì£¼ë¬¸ ë©”ë‰´ */
    .menu-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #e9ecef;
    }
    
    .menu-item:last-child {
      border-bottom: none;
    }
    
    .menu-info {
      flex: 1;
    }
    
    .menu-name {
      font-size: 16px;
      color: #2d3436;
      margin: 0 0 4px 0;
    }
    
    .menu-quantity {
      font-size: 14px;
      color: #6c757d;
      margin: 0;
    }
    
    .menu-price {
      font-size: 16px;
      font-weight: bold;
      color: #00d2be;
    }
    
    /* ë°°ì†¡ì§€ */
    .address-box {
      padding: 16px;
      background-color: #ffffff;
      border-radius: 8px;
      border: 2px solid #e9ecef;
    }
    
    .address-text {
      font-size: 15px;
      color: #2d3436;
      margin: 0;
      line-height: 1.6;
    }
    
    .change-address-btn {
      margin-top: 12px;
      padding: 8px 16px;
      background-color: #ffffff;
      color: #00d2be;
      border: 2px solid #00d2be;
      border-radius: 8px;
      font-family: 'Jua', sans-serif;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .change-address-btn:hover {
      background-color: #00d2be;
      color: #ffffff;
    }
    
    /* ì¿ í° */
    .coupon-select {
      width: 100%;
      padding: 12px;
      background-color: #ffffff;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-family: 'Jua', sans-serif;
      font-size: 15px;
      color: #2d3436;
      cursor: pointer;
      transition: border-color 0.3s ease;
    }
    
    .coupon-select:hover {
      border-color: #00d2be;
    }
    
    .coupon-select:focus {
      outline: none;
      border-color: #00d2be;
    }
    
    /* ê²°ì œ ë°©ì‹ */
    .payment-methods {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px; /* í•˜ë‹¨ ì—¬ë°± ì¶”ê°€ */
    }
    
    .payment-option {
      display: flex;
      align-items: center;
      padding: 16px;
      background-color: #ffffff;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .payment-option:hover {
      border-color: #00d2be;
      background-color: #f0fffe;
    }
    
    .payment-option.selected {
      border-color: #00d2be;
      background-color: #f0fffe;
    }
    
    .payment-radio {
      width: 20px;
      height: 20px;
      margin-right: 12px;
      cursor: pointer;
      accent-color: #00d2be;
    }
    
    .payment-label {
      font-size: 16px;
      color: #2d3436;
      cursor: pointer;
      flex: 1;
    }
    
    .payment-icon {
      font-size: 24px;
    }
    
    /* í•˜ë‹¨ ì£¼ë¬¸ ì˜ì—­ */
    .order-section {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 480px;
      background-color: #ffffff;
      border-top: 2px solid #f0f0f0;
      padding: 20px;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      z-index: 10;
    }
    
    .price-breakdown {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .price-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 15px;
      color: #6c757d;
    }
    
    .price-row.total {
      padding-top: 12px;
      border-top: 2px solid #e9ecef;
      font-size: 18px;
      font-weight: bold;
      color: #2d3436;
    }
    
    .price-row.total .price {
      color: #00d2be;
      font-size: 22px;
    }
    
    .price-row .discount {
      color: #dc3545;
    }
    
    .order-btn {
      width: 100%;
      padding: 16px;
      background-color: #00d2be;
      color: #ffffff;
      border: none;
      border-radius: 12px;
      font-family: 'Jua', sans-serif;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .order-btn:hover {
      background-color: #00b8a6;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 210, 190, 0.3);
    }
    
    .order-btn:active {
      transform: translateY(0);
    }
    
    .order-btn:disabled {
      background-color: #adb5bd;
      cursor: not-allowed;
      transform: none;
    }
    
    @media (max-width: 480px) {
      .menu-name {
        font-size: 15px;
      }
      
      .menu-price {
        font-size: 15px;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>

 </head>
 <body>
  <div class="app-container"><!-- ìƒë‹¨ë°” -->
   <header class="top-bar"><button class="back-btn" id="backBtn" aria-label="ë’¤ë¡œê°€ê¸°">â†</button>
    <h1 class="page-title" id="pageTitle">ì£¼ë¬¸</h1>
    <div class="placeholder"></div>
   </header><!-- ë©”ì¸ ì»¨í…ì¸  -->
   <main class="main-content" id="mainContent"><!-- ì£¼ë¬¸ ë©”ë‰´ -->
    <section class="section">
     <h2 class="section-title">ì£¼ë¬¸ ë©”ë‰´</h2>
     <div id="menuList"><!-- ë©”ë‰´ ì•„ì´í…œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
     </div>
    </section><!-- ë°°ì†¡ì§€ -->
    <section class="section">
     <h2 class="section-title">ë°°ì†¡ì§€</h2>
     <div class="address-box">
      <p class="address-text" id="addressText">ì£¼ì†Œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p><button class="change-address-btn" id="changeAddressBtn">ì£¼ì†Œ ë³€ê²½</button>
     </div>
    </section><!-- ì¿ í° -->
    <section class="section">
     <h2 class="section-title">ì¿ í°</h2><select class="coupon-select" id="couponSelect"> <option value="">ì¿ í°ì„ ì„ íƒí•˜ì„¸ìš”</option> </select>
    </section><!-- ê²°ì œ ë°©ì‹ -->
    <section class="section">
     <h2 class="section-title">ê²°ì œ ë°©ì‹</h2>
     <div class="payment-methods" id="paymentMethods">
       <!-- ê°€ê²Œì˜ ì§€ë¶ˆë°©ì‹ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
     </div>
    </section>
   </main><!-- í•˜ë‹¨ ì£¼ë¬¸ ì˜ì—­ -->
   <div class="order-section" id="orderSection">
    <div class="price-breakdown">
     <div class="price-row"><span>ì£¼ë¬¸ ê¸ˆì•¡</span> <span class="price" id="originalPrice">0ì›</span>
     </div>
     <div class="price-row" id="discountRow" style="display: none;"><span>ì¿ í° í• ì¸</span> <span class="price discount" id="discountPrice">-0ì›</span>
     </div>
     <div class="price-row total"><span>ìµœì¢… ê²°ì œ ê¸ˆì•¡</span> <span class="price" id="totalPrice">0ì›</span>
     </div>
    </div><button class="order-btn" id="orderBtn">ì£¼ë¬¸í•˜ê¸°</button>
   </div>
  </div>
  <script>
    const defaultConfig = {
      background_color: '#ffffff',
      primary_color: '#00d2be',
      text_color: '#2d3436',
      border_color: '#e9ecef',
      page_title: 'ì£¼ë¬¸',
      order_button_text: 'ì£¼ë¬¸í•˜ê¸°',
      font_family: 'Jua',
      font_size: 16
    };

    let cartData = [];
    let selectedCoupon = null;
    let selectedPayment = null; // í•˜ë‚˜ë§Œ ì„ íƒ ê°€ëŠ¥

    // ì¥ë°”êµ¬ë‹ˆ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    function loadCartData() {
      const savedCart = localStorage.getItem('cart');
      if (savedCart) {
        cartData = JSON.parse(savedCart);
      }
      renderMenuList();
      calculateTotal();
    }

    // ë©”ë‰´ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    function renderMenuList() {
      const menuList = document.getElementById('menuList');
      menuList.innerHTML = '';
      
      cartData.forEach(item => {
        const menuItem = document.createElement('div');
        menuItem.className = 'menu-item';
        menuItem.innerHTML = `
          <div class="menu-info">
            <p class="menu-name">${item.menuName}</p>
            <p class="menu-quantity">ìˆ˜ëŸ‰: ${item.quantity}ê°œ</p>
          </div>
          <span class="menu-price">${(item.price * item.quantity).toLocaleString()}ì›</span>
        `;
        menuList.appendChild(menuItem);
      });
    }

    // ì£¼ì†Œ ë¶ˆëŸ¬ì˜¤ê¸° - ë°±ì—”ë“œ APIì—ì„œ ê°€ì ¸ì˜¤ê¸°
    async function loadAddress() {
      const addressText = document.getElementById('addressText');
      
      try {
        const response = await fetch('/users/me');
        if (response.ok) {
          const user = await response.json();
          if (user.address) {
            addressText.textContent = user.address;
          } else {
            addressText.textContent = 'ë“±ë¡ëœ ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤. ì£¼ì†Œë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.';
          }
        } else {
          addressText.textContent = 'ì£¼ì†Œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.';
        }
      } catch (error) {
        console.error('ì£¼ì†Œ ë¡œë“œ ì˜¤ë¥˜:', error);
        addressText.textContent = 'ì£¼ì†Œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
      }
    }

    // ì¿ í° ë¶ˆëŸ¬ì˜¤ê¸° - ë°±ì—”ë“œ APIì—ì„œ ê°€ì ¸ì˜¤ê¸°
    async function loadCoupons() {
      const couponSelect = document.getElementById('couponSelect');
      couponSelect.innerHTML = '<option value="">ì¿ í° ì„ íƒ</option>';
      
      // URLì—ì„œ store_id ê°€ì ¸ì˜¤ê¸°
      const urlParams = new URLSearchParams(window.location.search);
      const storeId = urlParams.get('store_id');
      
      if (!storeId) {
        console.log('ê°€ê²Œ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      try {
        const response = await fetch(`/customer/stores/${storeId}/coupons`);
        if (response.ok) {
          const coupons = await response.json();
          
          coupons.forEach(coupon => {
            const option = document.createElement('option');
            option.value = JSON.stringify({
              id: coupon.id,
              discount: coupon.discount,
              period: coupon.period
            });
            option.textContent = `${coupon.discount}ì› í• ì¸ ì¿ í°`;
            couponSelect.appendChild(option);
          });
        }
      } catch (error) {
        console.error('ì¿ í° ë¡œë“œ ì˜¤ë¥˜:', error);
      }
    }

    // ê°€ê²Œì˜ ì§€ë¶ˆë°©ì‹ ë¶ˆëŸ¬ì˜¤ê¸° - ë°±ì—”ë“œ APIì—ì„œ ê°€ì ¸ì˜¤ê¸°
    async function loadStorePayments() {
      const paymentMethods = document.getElementById('paymentMethods');
      paymentMethods.innerHTML = '';
      
      // URLì—ì„œ store_id ê°€ì ¸ì˜¤ê¸°
      const urlParams = new URLSearchParams(window.location.search);
      const storeId = urlParams.get('store_id');
      
      if (!storeId) {
        console.log('ê°€ê²Œ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      try {
        const response = await fetch(`/customer/stores/${storeId}/payments`);
        if (response.ok) {
          const payments = await response.json();
          
          if (payments.length === 0) {
            paymentMethods.innerHTML = '<p style="color: #6c757d; text-align: center;">ì‚¬ìš© ê°€ëŠ¥í•œ ì§€ë¶ˆë°©ì‹ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
          }
          
          payments.forEach(payment => {
            const label = document.createElement('label');
            label.className = 'payment-option';
            label.id = `payment_${payment.id}`;
            
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = 'payment';
            radio.value = payment.id;
            radio.className = 'payment-radio';
            radio.id = `paymentRadio_${payment.id}`;
            
            const spanLabel = document.createElement('span');
            spanLabel.className = 'payment-label';
            spanLabel.textContent = payment.payment;
            
            const spanIcon = document.createElement('span');
            spanIcon.className = 'payment-icon';
            // ì§€ë¶ˆë°©ì‹ì— ë”°ë¼ ì•„ì´ì½˜ ì„¤ì •
            if (payment.payment.includes('ì¹´ë“œ')) {
              spanIcon.textContent = 'ğŸ’³';
            } else if (payment.payment.includes('í˜„ê¸ˆ')) {
              spanIcon.textContent = 'ğŸ’µ';
            } else {
              spanIcon.textContent = 'ğŸ’°';
            }
            
            label.appendChild(radio);
            label.appendChild(spanLabel);
            label.appendChild(spanIcon);
            paymentMethods.appendChild(label);
            
            // ë¼ë””ì˜¤ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            radio.addEventListener('change', function() {
              if (this.checked) {
                selectedPayment = parseInt(this.value);
                // ëª¨ë“  ì˜µì…˜ì—ì„œ selected í´ë˜ìŠ¤ ì œê±°
                document.querySelectorAll('.payment-option').forEach(opt => {
                  opt.classList.remove('selected');
                });
                // ì„ íƒëœ ì˜µì…˜ì— selected í´ë˜ìŠ¤ ì¶”ê°€
                this.closest('.payment-option').classList.add('selected');
              }
            });
            
            // ë¼ë²¨ í´ë¦­ ì‹œ ë¼ë””ì˜¤ ë²„íŠ¼ ì„ íƒ
            label.addEventListener('click', function(e) {
              if (e.target !== radio) {
                radio.checked = true;
                radio.dispatchEvent(new Event('change'));
              }
            });
          });
        }
      } catch (error) {
        console.error('ì§€ë¶ˆë°©ì‹ ë¡œë“œ ì˜¤ë¥˜:', error);
        paymentMethods.innerHTML = '<p style="color: #dc3545; text-align: center;">ì§€ë¶ˆë°©ì‹ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
      }
    }

    // ê¸ˆì•¡ ê³„ì‚°
    function calculateTotal() {
      const originalPrice = cartData.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      let discount = 0;
      
      if (selectedCoupon && selectedCoupon.discount) {
        discount = selectedCoupon.discount;
      }
      
      const totalPrice = originalPrice - discount;
      
      document.getElementById('originalPrice').textContent = originalPrice.toLocaleString() + 'ì›';
      document.getElementById('discountPrice').textContent = '-' + discount.toLocaleString() + 'ì›';
      document.getElementById('totalPrice').textContent = totalPrice.toLocaleString() + 'ì›';
      
      const discountRow = document.getElementById('discountRow');
      if (discount > 0) {
        discountRow.style.display = 'flex';
      } else {
        discountRow.style.display = 'none';
      }
    }

    async function onConfigChange(config) {
      document.getElementById('pageTitle').textContent = config.page_title || defaultConfig.page_title;
      document.getElementById('orderBtn').textContent = config.order_button_text || defaultConfig.order_button_text;
      
      const bgColor = config.background_color || defaultConfig.background_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const borderColor = config.border_color || defaultConfig.border_color;
      const fontFamily = config.font_family || defaultConfig.font_family;
      const fontSize = config.font_size || defaultConfig.font_size;
      
      document.querySelector('.app-container').style.backgroundColor = bgColor;
      document.querySelector('.top-bar').style.backgroundColor = bgColor;
      document.querySelector('.order-section').style.backgroundColor = bgColor;
      
      document.querySelector('.page-title').style.color = textColor;
      document.querySelector('.page-title').style.fontFamily = `${fontFamily}, sans-serif`;
      document.querySelector('.page-title').style.fontSize = `${fontSize * 1.5}px`;
      
      document.querySelectorAll('.section-title, .menu-name, .address-text, .payment-label').forEach(el => {
        el.style.color = textColor;
        el.style.fontFamily = `${fontFamily}, sans-serif`;
      });
      
      document.querySelectorAll('.menu-price').forEach(el => {
        el.style.color = primaryColor;
      });
      
      document.querySelectorAll('.section, .address-box, .payment-option').forEach(el => {
        el.style.borderColor = borderColor;
      });
      
      document.querySelector('.order-btn').style.backgroundColor = primaryColor;
      document.querySelector('.order-btn').style.fontFamily = `${fontFamily}, sans-serif`;
      document.querySelector('.order-btn').style.fontSize = `${fontSize * 1.125}px`;
      
      document.querySelector('.change-address-btn').style.color = primaryColor;
      document.querySelector('.change-address-btn').style.borderColor = primaryColor;
    }

    function mapToCapabilities(config) {
      return {
        recolorables: [
          {
            get: () => config.background_color || defaultConfig.background_color,
            set: (value) => {
              config.background_color = value;
              window.elementSdk.setConfig({ background_color: value });
            }
          },
          {
            get: () => config.primary_color || defaultConfig.primary_color,
            set: (value) => {
              config.primary_color = value;
              window.elementSdk.setConfig({ primary_color: value });
            }
          },
          {
            get: () => config.text_color || defaultConfig.text_color,
            set: (value) => {
              config.text_color = value;
              window.elementSdk.setConfig({ text_color: value });
            }
          },
          {
            get: () => config.border_color || defaultConfig.border_color,
            set: (value) => {
              config.border_color = value;
              window.elementSdk.setConfig({ border_color: value });
            }
          }
        ],
        borderables: [],
        fontEditable: {
          get: () => config.font_family || defaultConfig.font_family,
          set: (value) => {
            config.font_family = value;
            window.elementSdk.setConfig({ font_family: value });
          }
        },
        fontSizeable: {
          get: () => config.font_size || defaultConfig.font_size,
          set: (value) => {
            config.font_size = value;
            window.elementSdk.setConfig({ font_size: value });
          }
        }
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ['page_title', config.page_title || defaultConfig.page_title],
        ['order_button_text', config.order_button_text || defaultConfig.order_button_text]
      ]);
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });
    }

    // ì´ˆê¸° ë¡œë“œ
    loadCartData();
    loadAddress();
    loadCoupons();
    loadStorePayments();

    // ë’¤ë¡œê°€ê¸° ë²„íŠ¼
    document.getElementById('backBtn').addEventListener('click', () => {
    window.location.href = '/customer/orderlist';
    });
    /* document.getElementById('backBtn').addEventListener('click', () => {
      window.history.back();
    }); */

    // ì£¼ì†Œ ë³€ê²½ ë²„íŠ¼ - ì„¤ì • í˜ì´ì§€ë¡œ ì´ë™
    document.getElementById('changeAddressBtn').addEventListener('click', () => {
      if (confirm('ì„¤ì • í˜ì´ì§€ì—ì„œ ì£¼ì†Œë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        window.location.href = '/users/setting';
      }
    });

    // ì¿ í° ì„ íƒ
    document.getElementById('couponSelect').addEventListener('change', (e) => {
      if (e.target.value) {
        selectedCoupon = JSON.parse(e.target.value);
      } else {
        selectedCoupon = null;
      }
      calculateTotal();
    });

    // ê²°ì œ ë°©ì‹ ì„ íƒì€ loadStorePayments() í•¨ìˆ˜ ë‚´ì—ì„œ ì²˜ë¦¬ë¨

    // ì£¼ë¬¸í•˜ê¸° ë²„íŠ¼ - ë°±ì—”ë“œ API ì—°ë™
    document.getElementById('orderBtn').addEventListener('click', async () => {
      // ìœ íš¨ì„± ê²€ì‚¬
      if (cartData.length === 0) {
        alert('ì£¼ë¬¸í•  ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      if (!selectedPayment) {
        alert('ê²°ì œ ë°©ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // URLì—ì„œ store_id ê°€ì ¸ì˜¤ê¸°
      const urlParams = new URLSearchParams(window.location.search);
      const storeId = urlParams.get('store_id');
      
      if (!storeId) {
        alert('ê°€ê²Œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // ê°€ê²Œ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (minprice í™•ì¸ìš©)
      let storeMinprice = 0;
      try {
        const storeRes = await fetch(`/stores/${storeId}`);
        if (storeRes.ok) {
          const store = await storeRes.json();
          // minpriceì—ì„œ "ì›" ì œê±°í•˜ê³  ìˆ«ìë¡œ ë³€í™˜
          const minpriceStr = store.minprice ? store.minprice.replace(/ì›/g, '').replace(/,/g, '') : '0';
          storeMinprice = parseInt(minpriceStr) || 0;
        }
      } catch (e) {
        console.error('ê°€ê²Œ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨');
      }
      
      // ì‚¬ìš©ì ì£¼ì†Œ ê°€ì ¸ì˜¤ê¸°
      let userAddress = '';
      try {
        const userRes = await fetch('/users/me');
        if (userRes.ok) {
          const user = await userRes.json();
          userAddress = user.address || '';
        }
      } catch (e) {
        console.error('ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨');
      }
      
      if (!userAddress) {
        alert('ë°°ì†¡ì§€ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”. ì„¤ì • í˜ì´ì§€ì—ì„œ ì£¼ì†Œë¥¼ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }
      
      // ì£¼ë¬¸ ë‚´ìš© ìƒì„± (ë©”ë‰´ ëª©ë¡ì„ ë¬¸ìì—´ë¡œ)
      const orderItems = cartData.map(item => `${item.menuName} x${item.quantity}`).join(', ');
      
      // ì´ ê¸ˆì•¡ ê³„ì‚°
      let totalPrice = cartData.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      if (selectedCoupon && selectedCoupon.discount) {
        totalPrice -= selectedCoupon.discount;
      }
      
      // ìµœì†Œì£¼ë¬¸ê¸ˆì•¡ í™•ì¸
      if (storeMinprice > 0 && totalPrice < storeMinprice) {
        alert(`ìµœì†Œì£¼ë¬¸ê¸ˆì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.\nìµœì†Œì£¼ë¬¸ê¸ˆì•¡: ${storeMinprice.toLocaleString()}ì›\ní˜„ì¬ ê¸ˆì•¡: ${totalPrice.toLocaleString()}ì›`);
        return;
      }
      
      // ì£¼ë¬¸ ë°ì´í„° ìƒì„± (rider_idëŠ” ë°±ì—”ë“œì—ì„œ 0ìœ¼ë¡œ ì„¤ì •ë¨)
      const orderData = {
        store_id: parseInt(storeId),
        order: orderItems,
        total_price: totalPrice,
        payment_id: selectedPayment // ì„ íƒëœ ê²°ì œ ë°©ì‹ ID ì „ì†¡
      };
      
      try {
        // ë°±ì—”ë“œ APIë¡œ ì£¼ë¬¸ ìƒì„±
        const response = await fetch('/customer/orders', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(orderData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
          alert('ì£¼ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
          
          // ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê¸°
          localStorage.removeItem('cart');
          
          // ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
          window.location.href = '/customer/main';
        } else {
          if (response.status === 401) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/users/firstpage';
          } else {
            alert(data.error || 'ì£¼ë¬¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        }
      } catch (error) {
        console.error('ì£¼ë¬¸ ì˜¤ë¥˜:', error);
        alert('ì£¼ë¬¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });
  </script>
</html>