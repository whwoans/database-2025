<!doctype html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ê°€ê²Œ ìƒì„¸</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');

* { box-sizing: border-box; }

body {
  margin: 0; padding: 0;
  font-family: 'Jua', sans-serif;
  background-color: #f8f9fa;
}

.app-container {
  max-width: 480px;
  margin: 0 auto;
  background-color: #ffffff;
  min-height: 100vh;
}

/* ìƒë‹¨ë°” */
.top-bar {
  display: flex; justify-content: space-between; align-items: center;
  padding: 16px 20px;
  border-bottom: 2px solid #f0f0f0;
  background-color: #ffffff;
  position: sticky; top: 0;
  z-index: 10;
}

.back-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 8px;
  font-size: 24px;
  transition: transform 0.2s;
}

.back-btn:hover {
  transform: scale(1.1);
}

.app-title {
  font-size: 24px;
  font-weight: bold;
  color: #2d3436;
}

.top-icons {
  display: flex;
  gap: 16px;
}

.icon-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 8px;
  font-size: 24px;
  transition: transform 0.2s;
}

.icon-btn:hover { transform: scale(1.1); }

/* ì œëª© + ì°œ ë²„íŠ¼ */
.store-title-row {
  padding: 20px;
  border-bottom: 2px solid #f0f0f0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.store-name {
  font-size: 24px;
  color: #2d3436;
}

.like-toggle-btn {
  background: none;
  border: none;
  cursor: pointer;
}
.like-toggle-btn.active svg path {
  fill: #ff6b81;
  stroke: #ff6b81;
}

/* íƒ­ */
.tab-menu {
  display: flex;
  border-bottom: 2px solid #e9ecef;
  background-color: #ffffff;
}

.tab-btn {
  flex: 1;
  padding: 14px;
  background: none;
  border: none;
  color: #6c757d;
  font-size: 16px;
  cursor: pointer;
}

.tab-btn.active {
  border-bottom: 3px solid #00d2be;
  color: #00d2be;
  font-weight: bold;
}

.section {
  display: none;
  padding: 20px;
}
.section.active { display: block; }

/* ë©”ë‰´ */
.menu-item {
  display: flex;
  justify-content: space-between;
  padding: 14px;
  border: 2px solid #e9ecef;
  border-radius: 12px;
  background-color: #ffffff;
  margin-bottom: 14px;
  cursor: pointer;
  transition: 0.2s;
}
.menu-item:hover {
  border-color: #00d2be;
  box-shadow: 0 4px 12px rgba(0,210,190,0.2);
}
.menu-name { font-size: 17px; color: #2d3436; font-weight: bold; }
.menu-price { font-size: 17px; color: #00d2be; }

/* ë¦¬ë·° */
.review-box {
  padding: 12px 0;
  border-bottom: 1px solid #e9ecef;
}
.review-user { font-size: 15px; font-weight: bold; color: #2d3436; }
.review-text { margin-top: 4px; font-size: 14px; color: #6c757d; }

.info-text {
  font-size: 15px; color: #6c757d;
  line-height: 1.5; margin: 4px 0;
}
</style>
</head>

<body>
<div class="app-container">

<header class="top-bar">
  <button class="back-btn" id="backBtn" aria-label="ë’¤ë¡œê°€ê¸°">â†</button>
  <h1 class="app-title">ë§›ì§‘ DB</h1>
  <div class="top-icons">
    <button class="icon-btn" id="favoriteBtn">â¤ï¸</button>
    <button class="icon-btn" id="cartBtn">ğŸ›’</button>
  </div>
</header>

<div class="store-title-row">
  <h2 class="store-name" id="storeName">ê°€ê²Œëª…</h2>
  <button class="like-toggle-btn" id="likeToggleBtn">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none"
         stroke="#adb5bd" stroke-width="2">
      <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 
          0L12 5.67l-1.06-1.06a5.5 5.5 0 0 
          0-7.78 7.78l1.06 1.06L12 
          21.23l7.78-7.78 1.06-1.06a5.5 
          5.5 0 0 0 0-7.78z"></path>
    </svg>
  </button>
</div>

<div class="tab-menu">
  <button class="tab-btn active" data-tab="menu">ë©”ë‰´</button>
  <button class="tab-btn" data-tab="info">ê°€ê²Œì •ë³´</button>
  <button class="tab-btn" data-tab="review">ë¦¬ë·°</button>
</div>

<!-- ë©”ë‰´ ì„¹ì…˜ -->
<div class="section active" id="section-menu"></div>

<!-- ì •ë³´ ì„¹ì…˜ -->
<div class="section" id="section-info">
  <p class="info-text" id="info-desc"></p>
  <p class="info-text">ğŸ“ ì „í™”ë²ˆí˜¸: <span id="info-phone"></span></p>
  <p class="info-text">ğŸ• ìš´ì˜ì‹œê°„: <span id="info-operationTime"></span></p>
  <p class="info-text">ğŸ“… íœ´ë¬´ì¼: <span id="info-closedDay"></span></p>
  <p class="info-text" id="info-information" style="display:none; white-space: pre-wrap; line-height: 1.6; margin-top: 16px; padding-top: 16px; border-top: 1px solid #e9ecef;"></p>
  <p class="info-text">â­ í‰ì : <span id="info-rating"></span></p>
  <p class="info-text">ğŸ’¬ ë¦¬ë·° ìˆ˜: <span id="info-reviews"></span></p>
  <p class="info-text">ğŸ“¦ ì£¼ë¬¸ ìˆ˜: <span id="info-orders"></span></p>
</div>

<!-- ë¦¬ë·° ì„¹ì…˜ -->
<div class="section" id="section-review"></div>

</div>

<script>
// ---------- URL storeId ----------
// ë¼ìš°í„°ì—ì„œ ì „ë‹¬ëœ store_id ì‚¬ìš©
{% if store_id is defined %}
var storeId = {{ store_id }};
{% else %}
var storeId = parseInt(new URLSearchParams(location.search).get("id")) || 1;
{% endif %}

// ---------- ë°±ì—”ë“œ APIì—ì„œ ê°€ê²Œ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ----------
var storeData = null;

async function loadStoreData() {
  try {
    // ê°€ê²Œ ì •ë³´ ì¡°íšŒ
    const storeRes = await fetch(`/stores/${storeId}`);
    const store = await storeRes.json();
    
    // ë©”ë‰´ ì¡°íšŒ
    const menuRes = await fetch(`/customer/stores/${storeId}/menus`);
    const menus = await menuRes.json();
    
    // ë¦¬ë·° ì¡°íšŒ
    const reviewRes = await fetch(`/reviews/store/${storeId}`);
    const reviews = await reviewRes.json();
    
    // ì°œ ì—¬ë¶€ í™•ì¸
    let isLiked = false;
    try {
      const favoritesRes = await fetch('/favorites');
      if (favoritesRes.ok) {
        const favorites = await favoritesRes.json();
        isLiked = favorites.some(f => f.id === storeId);
      }
    } catch (e) {
      console.log('ì°œ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨ (ë¡œê·¸ì¸ í•„ìš”)');
    }
    
    // minpriceì—ì„œ "ì›" ì œê±° (ì´ë¯¸ "ì›"ì´ í¬í•¨ë˜ì–´ ìˆì„ ìˆ˜ ìˆìŒ)
    const minpriceValue = store.minprice ? store.minprice.replace(/ì›/g, '') : '0';
    
    // ë¦¬ë·°ì—ì„œ í‰ê·  ë³„ì  ê³„ì‚° (ë°±ì—”ë“œì—ì„œ ì œê³µí•˜ì§€ ì•ŠëŠ” ê²½ìš° ëŒ€ë¹„)
    let avgRating = 0;
    if (reviews.length > 0) {
      const sum = reviews.reduce((acc, r) => acc + (r.rating || 0), 0);
      avgRating = Math.round((sum / reviews.length) * 10) / 10; // ì†Œìˆ˜ì  ì²«ì§¸ìë¦¬ê¹Œì§€
    }
    
    storeData = {
      id: store.id,
      name: store.store_name,
      description: `${minpriceValue}ì› ì´ìƒ ì£¼ë¬¸ ê°€ëŠ¥`,
      phone: store.phone || '',
      operationTime: store.operationTime || '',
      closedDay: store.closedDay || '',
      information: store.information || '',  // ê°€ê²Œ ì •ë³´
      rating: store.avgRating || avgRating,  // ë°±ì—”ë“œì—ì„œ ê³„ì‚°ëœ í‰ê·  ë³„ì  ë˜ëŠ” í”„ë¡ íŠ¸ì—ì„œ ê³„ì‚°
      reviews: store.reviewCount || reviews.length,  // ì‹¤ì œ ë¦¬ë·° ìˆ˜
      orders: store.orderCount || 0,  // ë°±ì—”ë“œì—ì„œ ê³„ì‚°ëœ ì£¼ë¬¸ ìˆ˜
      menus: menus.map(m => ({ name: m.menu, price: m.price })),
      reviewsList: reviews.map(r => ({
        user: r.user_name || 'ìµëª…',
        rating: r.rating,
        text: r.content || ''
      })),
      isLiked: isLiked
    };
    
    // ---------- DOM ì±„ìš°ê¸° ----------
    document.getElementById("storeName").textContent = storeData.name;
    document.getElementById("info-desc").textContent = storeData.description;
    document.getElementById("info-phone").textContent = storeData.phone || 'ë“±ë¡ë˜ì§€ ì•ŠìŒ';
    document.getElementById("info-operationTime").textContent = storeData.operationTime || 'ë“±ë¡ë˜ì§€ ì•ŠìŒ';
    document.getElementById("info-closedDay").textContent = storeData.closedDay || 'ë“±ë¡ë˜ì§€ ì•ŠìŒ';
    if (storeData.information) {
      document.getElementById("info-information").textContent = storeData.information;
      document.getElementById("info-information").style.display = "block";
    } else {
      document.getElementById("info-information").style.display = "none";
    }
    document.getElementById("info-rating").textContent = storeData.rating;
    document.getElementById("info-reviews").textContent = storeData.reviews;
    document.getElementById("info-orders").textContent = storeData.orders;
    
    // ë©”ë‰´ ë Œë”ë§
    renderMenus();
    
    // ë¦¬ë·° ë Œë”ë§
    renderReviews();
    
    // ì°œ ìƒíƒœ ì—…ë°ì´íŠ¸
    updateHeart(storeData.isLiked);
    
  } catch (error) {
    console.error('ê°€ê²Œ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
    alert('ê°€ê²Œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

loadStoreData();

// ---------- ë©”ë‰´ ë Œë”ë§ ----------
function renderMenus() {
  if (!storeData || !storeData.menus) return;
  
  var menuSection = document.getElementById("section-menu");
  menuSection.innerHTML = "";
  storeData.menus.forEach(m => {
    var div = document.createElement("div");
    div.className = "menu-item";
    div.innerHTML = `
      <span class="menu-name">${m.name}</span>
      <span class="menu-price">${m.price.toLocaleString()}ì›</span>
    `;

    div.onclick = function () {
      // ì¥ë°”êµ¬ë‹ˆëŠ” ì„¸ì…˜ ë˜ëŠ” localStorageì— ì„ì‹œ ì €ì¥ (ì£¼ë¬¸ í˜ì´ì§€ì—ì„œ ì‚¬ìš©)
      var cart = JSON.parse(localStorage.getItem("cart") || "[]");

      // ë‹¤ë¥¸ ê°€ê²Œì˜ ë©”ë‰´ê°€ ì¥ë°”êµ¬ë‹ˆì— ìˆìœ¼ë©´ ê¸°ì¡´ ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê¸°
      if (cart.length > 0 && cart[0].storeId !== storeData.id) {
        if (confirm("ë‹¤ë¥¸ ê°€ê²Œì˜ ë©”ë‰´ê°€ ì¥ë°”êµ¬ë‹ˆì— ìˆìŠµë‹ˆë‹¤. ê¸°ì¡´ ì¥ë°”êµ¬ë‹ˆë¥¼ ë¹„ìš°ê³  ìƒˆë¡œ ë‹´ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          cart = [];
        } else {
          return; // ì‚¬ìš©ìê°€ ì·¨ì†Œí•˜ë©´ ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€í•˜ì§€ ì•ŠìŒ
        }
      }

      var found = cart.find(i =>
        i.storeId === storeData.id && i.menuName === m.name);

      if (found) found.quantity++;
      else {
        cart.push({
          storeId: storeData.id,
          storeName: storeData.name,
          menuName: m.name,
          price: m.price,
          quantity: 1,
          _id: Date.now() + Math.random() // ê³ ìœ  ID ì¶”ê°€
        });
      }

      localStorage.setItem("cart", JSON.stringify(cart));
      alert("ì¥ë°”êµ¬ë‹ˆì— ë‹´ì•˜ìŠµë‹ˆë‹¤!");
    };

    menuSection.appendChild(div);
  });
}

// ---------- ë¦¬ë·° ë Œë”ë§ ----------
function renderReviews() {
  if (!storeData || !storeData.reviewsList) return;
  
  var reviewSection = document.getElementById("section-review");
  reviewSection.innerHTML = "";
  
  if (storeData.reviewsList.length === 0) {
    reviewSection.innerHTML = '<p style="text-align:center;padding:20px;color:#adb5bd;">ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }
  
  storeData.reviewsList.forEach(r => {
    var box = document.createElement("div");
    box.className = "review-box";
    box.innerHTML = `
      <div class="review-user">â­${r.rating} ${r.user}</div>
      <div class="review-text">${r.text}</div>
    `;
    reviewSection.appendChild(box);
  });
}

// ---------- íƒ­ ì „í™˜ ----------
document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.addEventListener("click", function () {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));

    this.classList.add("active");
    document.getElementById("section-" + this.dataset.tab).classList.add("active");
  });
});

/* ============================================================
   7) ì°œ ê¸°ëŠ¥ - ë°±ì—”ë“œ API ì—°ë™
   ============================================================ */
const likeBtn = document.getElementById("likeToggleBtn");
const heartPath = likeBtn.querySelector("path");

function updateHeart(active) {
  if (active) {
    likeBtn.classList.add("active");
    heartPath.setAttribute("fill", "#ff6b81");
    heartPath.setAttribute("stroke", "#ff6b81");
  } else {
    likeBtn.classList.remove("active");
    heartPath.setAttribute("fill", "none");
    heartPath.setAttribute("stroke", "#adb5bd");
  }
}

// ì°œ ë²„íŠ¼ í´ë¦­ - ë°±ì—”ë“œ API í˜¸ì¶œ
likeBtn.onclick = async () => {
  if (!storeData) return;
  
  try {
    if (storeData.isLiked) {
      // ì°œ í•´ì œ
      const response = await fetch(`/favorites/${storeId}`, {
        method: 'DELETE'
      });
      
      if (response.ok) {
        storeData.isLiked = false;
        updateHeart(false);
        alert("ì°œ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
      } else {
        const data = await response.json();
        alert(data.error || "ì°œ í•´ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      }
    } else {
      // ì°œ ì¶”ê°€
      const response = await fetch('/favorites', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          store_id: storeId
        })
      });
      
      if (response.ok) {
        storeData.isLiked = true;
        updateHeart(true);
        alert("ì°œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");
      } else {
        const data = await response.json();
        alert(data.error || "ì°œ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      }
    }
  } catch (error) {
    console.error('ì°œ ê¸°ëŠ¥ ì˜¤ë¥˜:', error);
    alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
  }
};


// ---------- ìƒë‹¨ ë²„íŠ¼ ----------
document.getElementById("favoriteBtn").onclick = () => location.href = "/favorites/page";
document.getElementById("cartBtn").onclick = () => location.href = "/customer/cart";

const backBtn = document.getElementById("backBtn");
if (backBtn) {
  backBtn.addEventListener("click", () => {
    // ê°€ê²Œ ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™
    window.location.href = "/customer/storelist";
  });
}

</script>

</body>
</html>
