<!doctype html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë¼ì´ë” í˜ì´ì§€</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');

body {
  margin: 0;
  padding: 0;
  background: #f8f9fa;
  font-family: 'Jua', sans-serif;
}

.app-container {
  max-width: 480px;
  margin: 0 auto;
  min-height: 100vh;
  background: #fff;
  box-shadow: 0 0 20px rgba(0,0,0,0.1);
}

/* ìƒë‹¨ë°” */
.top-bar {
  display: flex;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 2px solid #eee;
}

.back-btn {
  background: none;
  border: none;
  font-size: 26px;
  cursor: pointer;
  margin-right: 10px;
}

.page-title {
  font-size: 24px;
  font-weight: bold;
  flex: 1;
  text-align: center;
  margin-right: 35px;
}

/* ì£¼ë¬¸ ì¹´ë“œ */
.order-card {
  background: #f8f9fa;
  border: 2px solid #e9ecef;
  border-radius: 12px;
  padding: 16px;
  margin: 16px;
}

.order-title {
  font-size: 20px;
  font-weight: bold;
  margin-bottom: 6px;
}

.order-text {
  font-size: 16px;
  color: #555;
  margin: 4px 0;
}

.order-btns {
  display: flex;
  justify-content: space-between;
  margin-top: 12px;
}

.accept-btn, .deny-btn, .done-btn {
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: 10px;
  color: white;
  font-size: 16px;
  cursor: pointer;
  margin-right: 8px;
  font-family: 'Jua', sans-serif;
}

.accept-btn { background: #00d2be; }
.deny-btn { background: #ff7675; }
.done-btn { background: #6c5ce7; }

.accept-btn:last-child, 
.deny-btn:last-child,
.done-btn:last-child {
  margin-right: 0;
}

.empty-box {
  text-align: center;
  margin-top: 50px;
  color: #aaa;
  font-size: 18px;
}
</style>
</head>

<body>
<div class="app-container">

  <!-- ìƒë‹¨ë°” -->
  <header class="top-bar">
    <button class="back-btn" onclick="location.href='/users/setting'">â†</button>
    <h1 class="page-title">ë¼ì´ë” í˜ì´ì§€</h1>
  </header>

  <!-- ë¼ì´ë” ë“±ë¡ í¼ (ì²˜ìŒ ì ‘ì† ì‹œ) -->
  <div id="riderRegistrationForm" style="display: none;">
    <div style="padding: 20px;">
      <h2 style="font-size: 20px; margin-bottom: 20px; text-align: center;">ë¼ì´ë” ì •ë³´ ë“±ë¡</h2>
      
      <div style="margin-bottom: 16px;">
        <label style="display: block; font-size: 16px; margin-bottom: 8px;">í•¸ë“œí° ë²ˆí˜¸</label>
        <input type="text" id="riderPhone" placeholder="010-1234-5678" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-family: 'Jua', sans-serif; font-size: 16px; box-sizing: border-box;">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; font-size: 16px; margin-bottom: 8px;">ì´ë™ìˆ˜ë‹¨</label>
        <select id="riderVehicle" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-family: 'Jua', sans-serif; font-size: 16px; box-sizing: border-box;">
          <option value="">ì´ë™ìˆ˜ë‹¨ ì„ íƒ</option>
          <option value="ì˜¤í† ë°”ì´">ì˜¤í† ë°”ì´</option>
          <option value="ìì „ê±°">ìì „ê±°</option>
          <option value="ë„ë³´">ë„ë³´</option>
          <option value="ìë™ì°¨">ìë™ì°¨</option>
        </select>
      </div>
      
      <button id="registerRiderBtn" style="width: 100%; padding: 16px; background-color: #00d2be; color: white; border: none; border-radius: 10px; font-family: 'Jua', sans-serif; font-size: 18px; font-weight: bold; cursor: pointer;">ë“±ë¡í•˜ê¸°</button>
    </div>
  </div>

  <!-- ì£¼ë¬¸ ëª©ë¡ (ë“±ë¡ í›„) -->
  <div id="orderList"></div>

</div>

<script>
// =====================================
// 1) ë¼ì´ë” ë“±ë¡ ì—¬ë¶€ í™•ì¸ ë° í™”ë©´ ë¶„ê¸°
// =====================================
let user = null;
let rider = null;

async function checkRiderRegistration() {
  try {
    // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ í™•ì¸
    const userResponse = await fetch('/users/me');
    
    if (!userResponse.ok) {
      if (userResponse.status === 401) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = '/users/firstpage';
        return;
      }
      throw new Error('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }

    user = await userResponse.json();

    // Userì˜ user_idë¡œ Rider ì¡°íšŒ
    const riderResponse = await fetch(`/riders/by-user-id/${user.user_id}`);
    
    if (riderResponse.ok) {
      rider = await riderResponse.json();
      // ë¼ì´ë”ê°€ ë“±ë¡ë˜ì–´ ìˆìœ¼ë©´ ì£¼ë¬¸ ëª©ë¡ í‘œì‹œ
      document.getElementById('riderRegistrationForm').style.display = 'none';
      document.getElementById('orderList').style.display = 'block';
      await loadOrders();
    } else {
      // ë¼ì´ë”ê°€ ë“±ë¡ë˜ì–´ ìˆì§€ ì•Šìœ¼ë©´ ë“±ë¡ í¼ í‘œì‹œ
      document.getElementById('riderRegistrationForm').style.display = 'block';
      document.getElementById('orderList').style.display = 'none';
    }
  } catch (error) {
    console.error('ë¼ì´ë” í™•ì¸ ì˜¤ë¥˜:', error);
    // ì˜¤ë¥˜ ì‹œ ë“±ë¡ í¼ í‘œì‹œ
    document.getElementById('riderRegistrationForm').style.display = 'block';
    document.getElementById('orderList').style.display = 'none';
  }
}

// =====================================
// 2) ë¼ì´ë” ë“±ë¡
// =====================================
async function registerRider() {
  const phone = document.getElementById('riderPhone').value.trim();
  const vehicle = document.getElementById('riderVehicle').value;

  if (!phone) {
    alert('í•¸ë“œí° ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }

  if (!vehicle) {
    alert('ì´ë™ìˆ˜ë‹¨ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }

  if (!user) {
    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    return;
  }

  try {
    const response = await fetch('/riders/register', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        rider_id: user.user_id, // Userì˜ user_idë¥¼ rider_idë¡œ ì‚¬ìš©
        phone: phone,
        vehicle: vehicle
      })
    });

    const data = await response.json();

    if (response.ok) {
      alert('ë¼ì´ë” ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
      // ë“±ë¡ í›„ ì£¼ë¬¸ ëª©ë¡ í™”ë©´ìœ¼ë¡œ ì „í™˜
      await checkRiderRegistration();
    } else {
      alert(data.error || 'ë¼ì´ë” ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  } catch (error) {
    console.error('ë¼ì´ë” ë“±ë¡ ì˜¤ë¥˜:', error);
    alert('ë¼ì´ë” ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

// =====================================
// 3) ë°±ì—”ë“œ APIì—ì„œ ì£¼ë¬¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
// =====================================
async function loadOrders() {
  try {
    // ëŒ€ê¸° ì¤‘ì¸ ì£¼ë¬¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ë¼ì´ë”ê°€ ìˆ˜ë½í•  ìˆ˜ ìˆëŠ” ì£¼ë¬¸)
    const ordersResponse = await fetch('/customer/orders/waiting');
    
    if (ordersResponse.ok) {
      const waitingOrders = await ordersResponse.json();
      renderOrders(waitingOrders);
    } else {
      renderOrders([]);
    }
  } catch (error) {
    console.error('ì£¼ë¬¸ ë¡œë“œ ì˜¤ë¥˜:', error);
    renderOrders([]);
  }
}

// =====================================
// 2) í™”ë©´ ë Œë”ë§
// =====================================
function renderOrders(waitingOrders) {
  const box = document.getElementById("orderList");
  box.innerHTML = "";

  if (waitingOrders.length === 0) {
    box.innerHTML = `<p class="empty-box">ëŒ€ê¸° ì¤‘ì¸ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤ ğŸš´â€â™‚ï¸</p>`;
    return;
  }

  waitingOrders.forEach(order => {
    const div = document.createElement("div");
    div.className = "order-card";

    div.innerHTML = `
      <div class="order-title">${order.store_name || 'ê°€ê²Œëª… ì—†ìŒ'}</div>
      <div class="order-text">ì£¼ë¬¸ì: ${order.user_name || 'ì‚¬ìš©ì'}</div>
      <div class="order-text">ì£¼ì†Œ: ${order.user_address || 'ì£¼ì†Œ ì—†ìŒ'}</div>
      <div class="order-text">ì£¼ë¬¸ ë‚´ìš©: ${order.order || 'ì£¼ë¬¸ ë‚´ìš© ì—†ìŒ'}</div>
      <div class="order-text">ì´ ê¸ˆì•¡: ${order.total_price?.toLocaleString() || 0}ì›</div>

      <div class="order-btns">
        <button class="accept-btn" onclick="acceptOrder(${order.id})">ìˆ˜ë½</button>
        <button class="deny-btn" onclick="denyOrder(${order.id})">ê±°ì ˆ</button>
      </div>
    `;

    box.appendChild(div);
  });
}

// =====================================
// 3) ìˆ˜ë½ / ê±°ì ˆ / ì™„ë£Œ ê¸°ëŠ¥ - ë°±ì—”ë“œ API ì—°ë™
// =====================================
async function acceptOrder(orderId) {
  if (!user || !rider) {
    alert('ë¼ì´ë” ë“±ë¡ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    return;
  }

  try {
    // Rider IDë¡œ ì£¼ë¬¸ ìˆ˜ë½
    const response = await fetch(`/customer/orders/${orderId}/accept`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        rider_id: rider.id  // Rider ID ì‚¬ìš©
      })
    });

    if (response.ok) {
      alert("ì£¼ë¬¸ì„ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤!");
      // ì£¼ë¬¸ ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
      await loadOrders();
    } else {
      const data = await response.json();
      alert(data.error || "ì£¼ë¬¸ ìˆ˜ë½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
  } catch (error) {
    console.error('ì£¼ë¬¸ ìˆ˜ë½ ì˜¤ë¥˜:', error);
    alert("ì£¼ë¬¸ ìˆ˜ë½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}

async function denyOrder(orderId) {
  if (!confirm("ì •ë§ ì£¼ë¬¸ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  try {
    // ì£¼ë¬¸ ê±°ì ˆì€ ë‹¨ìˆœíˆ ë¬´ì‹œ (ì‹¤ì œë¡œëŠ” ì£¼ë¬¸ ìƒíƒœ ë³€ê²½ API í•„ìš”)
    alert("ì£¼ë¬¸ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.");
    // ì£¼ë¬¸ ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
    await loadOrders();
  } catch (error) {
    console.error('ì£¼ë¬¸ ê±°ì ˆ ì˜¤ë¥˜:', error);
    alert("ì£¼ë¬¸ ê±°ì ˆ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}

async function finishOrder(orderId) {
  if (!confirm("ë°°ë‹¬ì„ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  try {
    // ë°°ë‹¬ ì™„ë£Œ API
    const response = await fetch(`/customer/orders/${orderId}/complete`, {
      method: 'POST'
    });

    if (response.ok) {
      alert("ë°°ë‹¬ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
      // ì£¼ë¬¸ ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
      await loadOrders();
    } else {
      const data = await response.json();
      alert(data.error || "ë°°ë‹¬ ì™„ë£Œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
  } catch (error) {
    console.error('ë°°ë‹¬ ì™„ë£Œ ì˜¤ë¥˜:', error);
    alert("ë°°ë‹¬ ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}

// =====================================
// FastAPI êµì²´ ì˜ˆì • (ì°¸ê³ )
// =====================================
/*
fetch("/api/orders/waiting")
fetch("/api/orders/{id}/accept")
fetch("/api/orders/{id}/deny")
fetch("/api/orders/{id}/deliver")
*/

// =====================================
// ì´ˆê¸° í™”ë©´
// =====================================
// ë“±ë¡ ë²„íŠ¼ ì´ë²¤íŠ¸
document.getElementById('registerRiderBtn').addEventListener('click', registerRider);

// ì´ˆê¸° ë¡œë“œ - ë¼ì´ë” ë“±ë¡ ì—¬ë¶€ í™•ì¸
checkRiderRegistration();
</script>

</body>
</html>
